#!/usr/bin/env bash

indent() {
    sed -u 's/^/       /'
}

BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3

BUILD_APP=$(cat "${ENV_DIR}/BUILD_APP")

if [[ -z "${BUILD_APP}" ]]; then
    echo "BUILD_APP was not set. Aborting" | indent
    exit 1
fi

declare -a SCRIPTS=(
  ".scripts.build = \"nx build $BUILD_APP\""
  ".scripts.start = \"ls && cd dist/apps/$BUILD_APP && next start\""
  ".scripts.\"start:prod\"=\"cd dist/apps/$BUILD_APP && next start\""
)

echo 'Patching package.json...'

for ((i = 0; i < ${#SCRIPTS[@]}; i++))
do
  SCRIPT="${SCRIPTS[$i]}"
  echo "Patch jq command: '$SCRIPT'" | indent
  CMD="jq '$SCRIPT' ${BUILD_DIR}/package.json > ${BUILD_DIR}/tmp.$$.json && mv ${BUILD_DIR}/tmp.$$.json ${BUILD_DIR}/package.json"
  #echo $CMD
  eval "$CMD"
done

echo "Updated build, start and start:prod scripts in package.json with: $BUILD_APP"

cat ${BUILD_DIR}/package.json

echo "Set up ${BUILD_APP} to be started from package.json" | indent